name: Get Food Rescue Hero Data

on:
  workflow_dispatch:

env:
  REPORT_FILE: data/rescues.csv

jobs:
  get-rescues-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        run: uv python install --project data
      
      - name: Activate venv & Install dependencies
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -r data/pyproject.toml
      
      - name: Run Python script to get data
        env:
          FOOD_RESCUE_HERO_USERNAME: ${{ secrets.FOOD_RESCUE_HERO_USERNAME }}
          FOOD_RESCUE_HERO_PASSWORD: ${{ secrets.FOOD_RESCUE_HERO_PASSWORD }}
        run: uv run python data/src/food_rescue_hero.py --dest-file-path $REPORT_FILE
  
  upload-to-gcs:
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
    - id: 'checkout'
      uses: 'actions/checkout@v4'
    
    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        project_id: 'data-projects-348920'
        workload_identity_provider: projects/407455095437/locations/global/workloadIdentityPools/github/providers/havens-harvest-data
        service_account: havens-harvest-data@data-projects-348920.iam.gserviceaccount.com
    
    - id: 'upload-file'
      uses: 'google-github-actions/upload-cloud-storage@v2'
      with:
        path: 'data'
        destination: marta-realtime-data
